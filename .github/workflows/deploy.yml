name: CI/CD Pipeline

# 触发条件: 当有人 push 代码到 main 分支时
on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 把 GitHub 上的代码拉取下来
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. 登录 Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 3. 构建并推送镜像 (CPU版 PyTorch)
    - name: Build and Push Docker Image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/soft-robot-api:latest
        # 这一步会自动处理 amd64 架构，因为 GitHub Runner 本身就是 x86 的

    # 4. 远程连接 AWS 并重启服务
    - name: Deploy to AWS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.AWS_USER }}
        key: ${{ secrets.AWS_PRIVATE_KEY }}
        script: |
          # 停止旧容器 (如果存在)
          docker stop soft-robot-v2 || true
          docker rm soft-robot-v2 || true
          
          # 强制拉取最新镜像
          docker pull ${{ secrets.DOCKER_USERNAME }}/soft-robot-api:latest
          
          # 启动新容器
          docker run -d -p 8000:8000 --name soft-robot-v2 ${{ secrets.DOCKER_USERNAME }}/soft-robot-api:latest